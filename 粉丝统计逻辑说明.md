# UmaFan 粉丝统计逻辑详细说明

## 📊 当前统计逻辑概述

本文档详细说明了 `src/umafan/dataLoader.ts` 中的粉丝统计计算逻辑，帮助理解和修改现有的计算方式。

---

## 🗂️ 数据结构

### 原始数据格式 (JSON 文件)

每个 JSON 文件代表一天的快照数据，文件名格式为 `YYYYMMDD.json`

```json
{
  "121130161": {                    // 外层 key 是 viewer_id
    "name": "海老冢智",              // 玩家名称
    "fan": 901636474,               // 当日粉丝总数（累计值）
    "circle_name": "魔結社2会",      // 公会名称
    "ts": "20251115",               // 时间戳
    "viewer_id": 121130161,         // 玩家 ID
    "comment": "死了",               // 备注
    "rank_score": 11022788,         // 排名分数
    "circle_id": 391405678          // 公会 ID
  }
}
```

**重要**: `fan` 字段是**累计粉丝总数**，不是当日新增！

---

## 🔄 数据处理流程

### 1. 数据加载阶段

```typescript
// 使用 Vite 的 glob 导入，自动加载所有 JSON 文件
const dataModules = import.meta.glob("./data/*.json", { eager: true, import: "default" })

// 数据组织结构
dataByDate: Map<string, Record<string, FanRecordRaw>>
// 例如: "20251115" -> { "121130161": {...}, "124460894": {...} }

circleMap: Map<number, string>
// 例如: 391405678 -> "魔結社2会"
```

**处理步骤**:
1. 扫描所有 JSON 文件
2. 提取日期（从文件名）
3. 按日期存储数据
4. 收集所有公会信息（去重）
5. 排序日期和公会列表

---

### 2. 用户选择阶段

用户在 UI 中选择：
- **公会 ID** (circleId): 例如 391405678
- **起始日期** (start): 例如 "20251101"
- **结束日期** (end): 例如 "20251115"

---

### 3. 数据筛选阶段 (`getUmaOverview` 函数)

```typescript
// 筛选指定公会在指定日期范围内的数据
for (const date of sortedDates) {
  if (date < rangeStart || date > rangeEnd) continue  // 跳过范围外的日期
  
  const filteredEntries = Object.values(rawRecords)
    .filter((record) => record.circle_id === circleId)  // 只保留指定公会的玩家
}
```

**结果**: `recordsByDate` - 按日期组织的该公会玩家记录

---

## 📈 核心统计计算

### 4. 构建玩家时间线 (`buildTimelines` 函数)

**目的**: 将按日期分散的数据，重组为按玩家 ID 组织的时间线

**输入**: 
```
recordsByDate: {
  "20251101": { "121130161": {fan: 850000000}, "124460894": {fan: 600000000} },
  "20251102": { "121130161": {fan: 851000000}, "124460894": {fan: 601000000} },
  ...
}
```

**输出**:
```
timelines: {
  "121130161": {
    name: "海老冢智",
    comment: "死了",
    history: [
      { date: "20251101", fans: 850000000 },
      { date: "20251102", fans: 851000000 },
      ...
    ]
  },
  "124460894": { ... }
}
```

**逻辑**:
```typescript
for (const date of orderedDates) {
  recordMap.forEach((record, playerId) => {
    const timeline = timelines.get(playerId) ?? { history: [] }
    timeline.name = record.name ?? timeline.name
    timeline.comment = record.comment ?? timeline.comment
    timeline.history.push({ date, fans: record.fan })  // 记录每天的粉丝数
    timelines.set(playerId, timeline)
  })
}
```

---

### 5. 构建玩家成长表格 (`buildTable` 函数)

**目的**: 计算每个玩家在时间段内的粉丝增长

**计算逻辑**:
```typescript
const firstEntry = history[0]        // 第一天的记录
const lastEntry = history[history.length - 1]  // 最后一天的记录

const startFans = firstEntry.fans    // 起始粉丝数
const endFans = lastEntry.fans       // 结束粉丝数
const increase = Math.max(0, endFans - startFans)  // 增长量（不允许负数）
```

**示例**:
- 玩家 A 在 2025-11-01 有 850,000,000 粉丝
- 玩家 A 在 2025-11-15 有 901,636,474 粉丝
- 增长量 = 901,636,474 - 850,000,000 = 51,636,474

**排序**: 按增长量降序排列

**输出**: `PlayerGrowth[]` 数组，用于表格展示

---

### 6. 计算总粉丝增长 (`getUmaOverview` 函数)

**当前逻辑**:
```typescript
const totalIncrease = table.reduce((sum, row) => sum + row.increase, 0)
```

**计算方式**: 累加所有玩家的个人增长量

**示例**:
- 玩家 A 增长: 51,636,474
- 玩家 B 增长: 58,405,555
- 玩家 C 增长: 20,003,155
- **总增长 = 51,636,474 + 58,405,555 + 20,003,155 = 130,045,184**

**⚠️ 注意**: 这个方法**不考虑玩家进出公会**的情况！

---

### 7. 构建图表数据 (`buildChartData` 函数)

**目的**: 生成每日总粉丝数和每日新增粉丝数的数组

#### 7.1 计算每日总粉丝数

**逻辑**:
```typescript
for (const date of dates) {
  let sum = 0
  timelines.forEach((timeline) => {
    const fans = fansAtOrBefore(timeline.history, date)  // 获取该玩家在该日期的粉丝数
    if (fans != null) {
      sum += fans
    }
  })
  totalFans.push(sum)  // 当日所有玩家的粉丝总和
}
```

**`fansAtOrBefore` 函数**:
```typescript
function fansAtOrBefore(entries, targetDate) {
  let result = undefined
  for (const entry of entries) {
    if (entry.date > targetDate) break  // 超过目标日期就停止
    result = entry.fans  // 记录最新的粉丝数
  }
  return result ?? null
}
```

**关键点**: 
- 如果玩家在某天没有记录，使用该玩家**之前最近一天**的粉丝数
- 这样可以处理数据缺失的情况

**示例**:
```
日期        玩家A粉丝    玩家B粉丝    总粉丝数
20251101   850000000   600000000   1450000000
20251102   851000000   601000000   1452000000
20251103   (缺失)      602000000   1453000000  (玩家A使用20251102的数据)
```

#### 7.2 计算每日新增粉丝数

**逻辑**:
```typescript
const previous = totalFans.length > 1 
  ? totalFans[totalFans.length - 2] ?? sum 
  : sum

dailyNewFans.push(sum - previous)  // 当日总数 - 前一日总数
```

**示例**:
```
日期        总粉丝数      每日新增
20251101   1450000000   1450000000  (第一天，新增 = 总数)
20251102   1452000000   2000000     (1452000000 - 1450000000)
20251103   1453000000   1000000     (1453000000 - 1452000000)
```

**⚠️ 注意**: 
- 第一天的"每日新增"等于第一天的总数（这可能不符合预期）
- 如果有玩家退出公会，每日新增可能为负数（但代码中没有处理）

---

### 8. 计算"今日新增粉丝" (`getUmaOverview` 函数)

**当前逻辑**:
```typescript
let todayNewFans = 0
if (chart.totalFans.length) {
  if (chart.totalFans.length === 1) {
    // 如果只有一天的数据，今日新增 = 总增长
    todayNewFans = totalIncrease
  } else {
    // 否则，今日新增 = 最后一天的总数 - 倒数第二天的总数
    const size = chart.totalFans.length
    const lastTotal = chart.totalFans[size - 1] ?? 0
    const previousTotal = chart.totalFans[size - 2] ?? lastTotal
    todayNewFans = lastTotal - previousTotal
  }
}
```

**示例**:
- 倒数第二天总粉丝: 25,000,000,000
- 最后一天总粉丝: 25,100,000,000
- **今日新增 = 25,100,000,000 - 25,000,000,000 = 100,000,000**

---

## 🎯 关键指标总结

### 指标 1: 总粉丝增长 (fansTotalGrowth)

**计算公式**:
```
总粉丝增长 = Σ (每个玩家的结束粉丝数 - 起始粉丝数)
```

**代码位置**: `getUmaOverview` 函数
```typescript
const totalIncrease = table.reduce((sum, row) => sum + row.increase, 0)
```

**特点**:
- ✅ 反映所有玩家的个人成长总和
- ❌ 不考虑玩家进出公会的影响
- ❌ 如果有玩家中途加入，会低估实际增长
- ❌ 如果有玩家中途退出，会高估实际增长

---

### 指标 2: 今日新增粉丝 (todayNewFans)

**计算公式**:
```
今日新增 = 最后一天所有玩家粉丝总和 - 倒数第二天所有玩家粉丝总和
```

**代码位置**: `getUmaOverview` 函数
```typescript
const lastTotal = chart.totalFans[size - 1] ?? 0
const previousTotal = chart.totalFans[size - 2] ?? lastTotal
todayNewFans = lastTotal - previousTotal
```

**特点**:
- ✅ 反映公会整体的日增长
- ✅ 考虑了玩家进出公会的影响
- ❌ 如果选择的日期范围只有一天，会等于总增长（可能不准确）

---

### 指标 3: 图表数据

#### 每日总粉丝数 (totalFans)

**计算公式**:
```
某日总粉丝数 = Σ (该日所有在公会玩家的粉丝数)
```

**特点**:
- ✅ 显示公会的绝对粉丝规模
- ✅ 可以看到公会的整体趋势
- ⚠️ 如果玩家某天没有数据，使用之前最近一天的数据

#### 每日新增粉丝数 (dailyNewFans)

**计算公式**:
```
某日新增 = 该日总粉丝数 - 前一日总粉丝数
```

**特点**:
- ✅ 显示每天的增长波动
- ⚠️ 第一天的新增等于第一天的总数
- ⚠️ 可能出现负数（玩家退出或数据异常）

---

## 🔍 潜在问题分析

### 问题 1: 玩家进出公会的处理

**场景**:
- 玩家 A 在 11-01 有 100M 粉丝，在公会中
- 玩家 A 在 11-05 退出公会
- 玩家 B 在 11-10 加入公会，有 200M 粉丝

**当前逻辑的问题**:
1. **总粉丝增长**: 只计算在整个时间段内都在公会的玩家
   - 玩家 A 的增长会被计入（即使他已退出）
   - 玩家 B 的增长不会被计入（因为没有起始数据）

2. **每日总粉丝数**: 
   - 11-05 之后，玩家 A 的粉丝数仍会被计入（使用最后一次记录）
   - 这会导致图表不准确

---

### 问题 2: 数据缺失的处理

**场景**: 某个玩家在某些日期没有数据

**当前逻辑**: 使用该玩家之前最近一天的数据

**问题**: 
- 如果玩家实际上已经退出公会，但仍会使用旧数据
- 导致总粉丝数虚高

---

### 问题 3: 第一天的"每日新增"

**当前逻辑**: 第一天的每日新增 = 第一天的总粉丝数

**问题**: 
- 这个数字通常非常大（几十亿）
- 不代表真实的"新增"
- 会导致图表第一个点异常高

---

### 问题 4: 负增长的处理

**场景**: 玩家粉丝数减少（可能是数据错误或游戏机制）

**当前逻辑**: 
```typescript
const increase = Math.max(0, endFans - startFans)  // 强制不为负数
```

**问题**:
- 隐藏了负增长的情况
- 可能掩盖数据异常

---

## 💡 可能的改进方向

### 改进 1: 更准确的总增长计算

**方案 A**: 基于实际在公会的天数计算
```typescript
// 只计算在选定日期范围内实际存在的玩家
const totalIncrease = (endDateTotalFans - startDateTotalFans)
```

**方案 B**: 区分"玩家增长"和"公会增长"
- 玩家增长: 当前逻辑（个人成长总和）
- 公会增长: 结束日总粉丝 - 起始日总粉丝

---

### 改进 2: 处理玩家进出公会

**方案**: 标记玩家的加入/退出日期
```typescript
interface PlayerTimeline {
  firstDate: string   // 首次出现日期
  lastDate: string    // 最后出现日期
  isActive: boolean   // 是否仍在公会
}
```

---

### 改进 3: 优化第一天的每日新增

**方案**: 第一天的每日新增设为 0 或 null
```typescript
if (totalFans.length === 1) {
  dailyNewFans.push(0)  // 或者 null
} else {
  dailyNewFans.push(sum - previous)
}
```

---

### 改进 4: 显示负增长

**方案**: 移除 `Math.max(0, ...)` 限制
```typescript
const increase = endFans - startFans  // 允许负数
```

并在 UI 中用不同颜色显示负增长

---

### 改进 5: 数据验证

**方案**: 添加数据异常检测
```typescript
// 检测异常的粉丝数变化
if (Math.abs(increase) > threshold) {
  console.warn(`异常增长: 玩家 ${playerId}, 增长 ${increase}`)
}
```

---

## 📝 修改建议

### 如果你想修改计算逻辑，需要关注以下函数：

1. **`buildTable`** - 修改玩家个人增长的计算
2. **`buildChartData`** - 修改图表数据的生成
3. **`getUmaOverview`** - 修改总增长和今日新增的计算
4. **`fansAtOrBefore`** - 修改数据缺失时的处理方式

### 修改步骤：

1. 明确你想要的计算逻辑（例如：是否考虑玩家进出）
2. 在 `dataLoader.ts` 中修改相应函数
3. 测试不同的日期范围和公会
4. 验证 UI 显示是否符合预期

---

## 🧪 测试场景

建议测试以下场景：

1. **完整时间段**: 选择所有可用日期
2. **单日查询**: 只选择一天
3. **连续日期**: 选择连续的几天
4. **跨月查询**: 跨越月份边界
5. **数据缺失**: 包含某些玩家没有数据的日期

---

## 📊 当前数据示例

根据 `20251115.json` 文件：
- 公会: 魔結社2会 (ID: 391405678)
- 成员数: 29 人
- 最高粉丝: CaiSpecial (4,750,468,570)
- 最低粉丝: 牢鷄の匠巴 (54,219,943)

---

**文档创建日期**: 2025-11-18  
**对应代码版本**: src/umafan/dataLoader.ts
